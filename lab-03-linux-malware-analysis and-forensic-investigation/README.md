# Malware Analysis Lab 03: Introduction to Basic Tools and Linux Forensics

## Lab Overview

**Lab Focus:** Comprehensive Linux-based malware analysis using command-line utilities for file forensics, network investigation, and incident containment  
**Difficulty:** Intermediate    
**Author:** Mykyta Palamarchuk  
**Role:** SOC Analyst | Malware Analysis Specialist & Digital Forensics Investigator  
**Certification:** CompTIA Security+ (SY0-701)

### Environment Specifications
- **Platform:** Kali Linux with root access for comprehensive system analysis
- **Administrative Privileges:** Full system access required for malware investigation and process termination
- **Business Context:** Critical ransomware investigation with decryption key recovery objectives
- **Technology Focus:** Linux command-line forensics, file analysis, network monitoring, process investigation

---

## Learning Objectives

Upon completion of this lab, participants will demonstrate:

1. **File analysis proficiency** using Linux command-line utilities for malware type identification and characteristics assessment
2. **String extraction mastery** including Base64 decoding and hidden content discovery techniques
3. **Filesystem investigation skills** covering compressed filesystem mounting and file exploration methodologies
4. **Network forensics capabilities** using socket monitoring tools for malicious connection identification
5. **Process investigation techniques** utilizing system monitoring utilities for threat actor process identification
6. **Incident containment procedures** implementing proper malware removal and system remediation protocols

---

## Business Scenario

You are a digital forensics specialist responding to a critical ransomware incident that has compromised important organizational data. Intelligence suggests that a decryption key may be embedded within the malware executable found on the affected Linux system. Your objective is to conduct comprehensive malware analysis to extract the decryption key, identify active threats, and implement proper containment procedures. The investigation requires advanced Linux command-line skills and systematic forensic methodology to recover critical business data and prevent further compromise.

---

## Theoretical Foundation

### Linux Malware Analysis Fundamentals

Modern malware targeting Linux systems often employs sophisticated obfuscation techniques, embedded payloads, and persistent mechanisms that require specialized analysis approaches. Unlike Windows-based malware analysis, Linux environments provide powerful command-line utilities that enable comprehensive file and process investigation without requiring specialized proprietary tools.

**Core Analysis Utilities:**
- **`file`** - Magic number analysis for file type identification
- **`strings`** - Printable character extraction from binary files
- **`sha256sum`** - Cryptographic hash generation for file integrity verification
- **`base64`** - Encoding/decoding utility for obfuscated content analysis
- **`mount`** - Filesystem mounting for compressed archive investigation
- **`ss`/`netstat`** - Network socket monitoring for active connection analysis
- **`ps`** - Process monitoring for malicious activity identification

### Ransomware Investigation Methodology

Ransomware attacks often involve multi-stage payloads with encrypted content and embedded decryption keys. Advanced variants may embed the decryption key within the malware executable itself, requiring systematic file analysis and content extraction techniques to recover critical organizational data.

---

## Lab Exercises

### Exercise 1: Malware File Type Analysis

#### Task 1.1: File Identification and Classification

**Objective:** Conduct initial malware file analysis using Linux file identification utilities to determine executable characteristics and system compatibility.

**Investigation Scenario:** A suspicious executable file named `takeover.exe` has been discovered on a compromised Linux system. Initial analysis is required to determine file type, architecture, and potential execution capabilities within the Linux environment.

**File Analysis Procedure:**

```bash
# Navigate to malware location
cd /root/Desktop

# Execute file type analysis
file takeover.exe
```

**File Type Analysis Results:**

![File Type Analysis](https://raw.githubusercontent.com/Mustangrim/Email-Security-Analysis-Labs/main/assets/screenshots/lab03-file-type-analysis.png)

**Investigation Question:**
**What type of file is takeover.exe?**

**Multiple Choice Options:**
- A normal text file
- A Microsoft Windows executable
- An ELF 32-bit LSB executable
- **An ELF 64-bit LSB executable** ✓
- A Linux executable
- An image file
- A tarball

**Analysis Results:**
- **File Type:** ELF 64-bit LSB executable
- **Architecture:** x86-64 Linux compatible
- **Security Assessment:** Native Linux executable requiring immediate investigation
- **Execution Risk:** High - capable of direct execution on target system

**Forensic Significance:** ELF (Executable and Linkable Format) identification confirms native Linux malware designed for direct system execution, indicating sophisticated threat actor targeting Linux infrastructure.

---

### Exercise 2: String Extraction and Base64 Analysis

#### Task 2.1: Embedded Content Discovery and Hash Analysis

**Objective:** Extract printable strings from malware executable to identify embedded content, Base64 encoded payloads, and cryptographic signatures.

**String Extraction Procedure:**

```bash
# Extract all printable strings from malware
strings /root/Desktop/takeover.exe

# Generate SHA-256 hash of original malware
sha256sum /root/Desktop/takeover.exe
```

**Base64 Content Identification:**
Analysis reveals large Base64 encoded string embedded within the executable:

**Base64 String Structure:**
- **Start:** `aHNxcwcAAAAP6YhcAAACAAAAAAAEABEA0AIBAAQAAADgAAAAAAAAAK0FAAAAAAAApQUAAAAAAAD/`
- **Content:** [Extensive Base64 encoded payload]
- **End:** `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==`

**Original Malware Hash:**
- **SHA-256:** `9eb03c90febc5c004f1c1aeca924bb9f4ee5bb7e50d82ec90675b883e9fc09f5`

#### Task 2.2: Base64 Content Extraction and Hash Verification

**Objective:** Extract Base64 encoded content to separate file and generate cryptographic hash for payload identification.

**Content Extraction Procedure:**

```bash
# Create file containing extracted Base64 content
nano base64encoded

# Paste complete Base64 string and save file

# Generate SHA-256 hash of extracted content
sha256sum base64encoded
```

**Investigation Question:**
**What is the SHA-256 hash of the file you created?**

**Extraction Results:**
- **Base64 Content Hash:** `ac52694771f96079b40cb31e6eeaa35f9db96ccb6e7de70ecc8c5df15b380c0c`
- **Content Size:** [Determined by Base64 string length]
- **Payload Classification:** Encrypted or compressed content requiring further analysis

**Forensic Value:** Separate hash generation enables payload tracking and threat intelligence correlation for similar attack campaigns and malware variants.

---

### Exercise 3: Base64 Decoding and Filesystem Analysis

#### Task 3.1: Payload Decoding and File Type Investigation

**Objective:** Decode Base64 content and analyze resulting file structure to identify embedded filesystem or compressed archive.

**Decoding Procedure:**

```bash
# Decode Base64 content to binary file
base64 -d base64encoded > base64decoded

# Analyze decoded file type
file base64decoded
```

**Investigation Question:**
**What type of filesystem is encased in the newly created file?**

**Decoding Results:**
- **Filesystem Type:** Squashfs
- **Filesystem Details:** Little endian, version 4.0, xz compressed
- **File Size:** 1453 bytes
- **Inode Count:** 7 inodes
- **Block Size:** 131072 bytes
- **Creation Date:** Wed Mar 13 11:27:11 2019

**Technical Analysis:** Squashfs is a compressed read-only filesystem commonly used for embedded systems and software distribution, indicating sophisticated malware packaging techniques.

---

### Exercise 4: Filesystem Mounting and Decryption Key Recovery

#### Task 4.1: Squashfs Mounting and Content Exploration

**Objective:** Mount compressed filesystem and conduct systematic file exploration to locate embedded decryption key for ransomware recovery.

**Mounting Procedure:**

```bash
# Mount Squashfs filesystem to analysis directory
sudo mount base64decoded /mnt

# Navigate to mounted filesystem
cd /mnt

# Explore filesystem structure
ls -la

# Navigate through directory structure
cd snap
ls -la

cd hooks
ls -la

# Examine file contents for decryption key
cat install
```

**Filesystem Exploration Results:**

**Directory Structure:**
```
/mnt/
├── meta/
└── snap/
    └── hooks/
        └── install
```

**Decryption Key Discovery:**

```bash
#!/bin/bash

KEY=${1:'TewvyidnexictOsvilabquojTeirOfIcDotfogrydWacgeyThyrodmyntAnCues'}

fileExts=("*.py" "*.txt" "*.cpp" "*.png" "*.jpg" "*.sh" "*.pyc" \
```

**Investigation Question:**
**What is the key?**

**Key Recovery Results:**
- **Decryption Key:** `${1:'TewvyidnexictOsvilabquojTeirOfIcDotfogrydWacgeyThyrodmyntAnCues'}`
- **Key Location:** `/mnt/snap/hooks/install`
- **Key Context:** Bash script variable containing ransomware decryption key
- **Recovery Success:** Critical business data decryption now possible

**Business Impact:** Successful key extraction enables organizational data recovery without ransom payment, preventing financial loss and maintaining business continuity.

---

### Exercise 5: Network Activity Investigation

#### Task 5.1: Active Connection Monitoring and Malicious Process Identification

**Objective:** Utilize network monitoring tools to identify active malware connections and associated processes for threat containment.

**Network Analysis Procedure:**

```bash
# Monitor active network connections
ss -antp

# Alternative network monitoring command
netstat -antp

# Identify processes associated with suspicious connections
ps -ef | grep [PID]
```

**Network Connection Analysis:**

![Network Connections Analysis](https://raw.githubusercontent.com/Mustangrim/Email-Security-Analysis-Labs/main/assets/screenshots/lab03-network-connections-analysis.png)

**Connection Analysis Results:**

**Active Malicious Connection:**
- **Local Address:** Kali Linux workstation
- **Remote Address:** 10.231.51.43:1490
- **Connection State:** ESTABLISHED
- **Process Name:** Aeteij8fohxei3a
- **Process ID (PID):** 857

**Process Investigation:**

```bash
# Identify full process path
ps -ef | grep 857
```

**Process Analysis Results:**
```
root 857 1 0 Oct12 ? 00:00:00 /var/eequ9E/ia9Phi/Lo2Goh/Aeteij8fohxei3aithu8
root 32191 19173 0 00:37 pts/0 00:00:00 grep 857
```

**Investigation Questions:**

**Question 1: What IP address is the malware trying to connect to?**
- **Malicious IP Address:** 10.231.51.43
- **Threat Assessment:** External command and control server

**Question 2: What port is the malware trying to connect to?**
- **Malicious Port:** 1490
- **Communication Protocol:** TCP connection for data exfiltration or command reception

**Question 3: What is the full path of the malware that is trying to connect to somewhere?**
- **Malware Path:** `/var/eequ9E/ia9Phi/Lo2Goh/Aeteij8fohxei3aithu8`
- **Process Classification:** Active malware with network communication capabilities

**Threat Intelligence:** Network analysis reveals active command and control communication, indicating ongoing malware operation requiring immediate containment procedures.

---

### Exercise 6: Malware Containment and System Remediation

#### Task 6.1: Proper Malware Removal and Process Termination

**Objective:** Implement systematic malware removal procedures to ensure complete threat elimination and prevent reinfection.

**Containment Methodology:**
Proper malware removal requires specific sequence to prevent process restart:
1. **File Deletion** - Remove malware executable from filesystem
2. **Process Termination** - Kill active malware process using force termination

**Remediation Procedure:**

```bash
# Step 1: Remove malware file from filesystem
rm /var/eequ9E/ia9Phi/Lo2Goh/Aeteij8fohxei3aithu8

# Step 2: Terminate malware process with force kill
kill -9 857

# Verification: Confirm process termination
ps -ef | grep 857

# Verification: Confirm network connection closure
ss -antp | grep 10.231.51.43
```

**Remediation Tasks:**
1. **Remove the malware file from the filesystem**
2. **Kill the malware process using PID 857**

**Security Validation:**
- **File Removal Confirmation:** Malware executable no longer present in filesystem
- **Process Termination Verification:** PID 857 no longer active in process list
- **Network Connection Closure:** No active connections to malicious IP address
- **System Clean State:** Malware completely removed from system

**Incident Response Notes:** Sequential removal (file → process) prevents malware restart mechanisms and ensures complete threat elimination from compromised system.

---

## Technical Assessment

### Linux Command-Line Proficiency
- Advanced file analysis using `file`, `strings`, and `sha256sum` utilities for malware classification
- Base64 encoding/decoding techniques for obfuscated content analysis and payload extraction
- Filesystem mounting and exploration using `mount`, `ls`, `cd`, and `cat` for embedded content investigation
- Network monitoring using `ss` and `netstat` for active connection analysis and threat identification

### Malware Analysis Methodology
- Systematic file type identification and architecture analysis for execution risk assessment
- String extraction and cryptographic hash generation for payload classification and tracking
- Compressed filesystem analysis and content exploration for hidden data recovery
- Network forensics correlation between processes and external communication for threat attribution

### Digital Forensics Investigation
- Evidence preservation through hash generation and file extraction for legal admissibility
- Decryption key recovery from embedded filesystem structures for data restoration
- Process and network correlation for comprehensive threat landscape analysis
- Proper chain of custody documentation for incident response and threat intelligence

### Incident Response and Containment
- Systematic malware removal procedures preventing reinfection and persistence mechanisms
- Network connection termination for command and control communication disruption
- Process termination using appropriate force levels for complete threat elimination
- System validation procedures confirming successful threat containment and remediation

---

## SOC Applications

### Operational Use Cases
- **Ransomware Recovery Operations:** Decryption key extraction from malware samples for data restoration without ransom payment
- **Linux Malware Investigation:** Command-line analysis of ELF executables and embedded payloads in enterprise environments
- **Network Threat Hunting:** Active connection monitoring for command and control communication identification
- **Incident Containment:** Systematic malware removal procedures for compromised Linux systems

### Security Metrics Enhancement
- **Malware Family Classification:** Hash-based tracking and correlation for threat intelligence development
- **Recovery Success Rates:** Decryption key extraction effectiveness for ransomware incident response
- **Network Communication Analysis:** Command and control infrastructure mapping for threat actor attribution
- **Containment Efficiency:** Response time metrics for malware identification and removal procedures

### Enterprise Security Integration
- **SIEM Integration:** Command-line forensics results correlation with security information and event management platforms
- **Threat Intelligence Platform:** Hash and network indicator extraction for proactive threat detection enhancement
- **Incident Response Playbooks:** Linux malware analysis procedures for standardized investigation workflows
- **Security Awareness Training:** Real-world malware analysis examples for technical staff education and skill development

---

## Lab Completion

**Skills Validated:**
- Advanced Linux command-line malware analysis using native system utilities
- Base64 encoding/decoding techniques for obfuscated payload analysis and content extraction
- Compressed filesystem mounting and exploration for embedded content investigation
- Network forensics using socket monitoring tools for malicious communication identification
- Systematic malware removal and system remediation for complete threat elimination

**Technical Competencies:**
- Professional-grade file analysis and string extraction for malware classification
- Cryptographic hash generation and verification for evidence integrity and tracking
- Process investigation and correlation with network activity for comprehensive threat assessment
- Incident containment procedures following industry best practices for Linux environments

**Professional Applications:**
- Digital forensics specialist capabilities for ransomware investigation and data recovery
- SOC analyst advanced skills for Linux-based threat investigation and response
- Incident response team integration for systematic malware analysis and containment
- Threat intelligence analyst skills for malware family classification and infrastructure mapping

---

*This intermediate laboratory develops essential Linux malware analysis skills using command-line utilities, providing practical experience with real-world ransomware investigation scenarios and professional incident response procedures.*
